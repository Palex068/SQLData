# SQL – выборка данных, сортировка, агрегатные функции

# Содержание

+ [Тизер](#тизер)
+ [Термины лекции](#термины-лекции)
+ [Сортировка результатов запроса](#сортировка-результатов-запроса)
+ [Ограничение выборки (top, limit, fetch)](#ограничение-выборки-top-limit-fetch)
    + [Оператор LIMIT](#оператор-limit)
    + [Аналоги: извлечение диапазона строк в MS SQL Server](#аналоги-извлечение-диапазона-строк-в-ms-sql-server)
    + [Оператор fetch](#оператор-fetch)
+ [Уникальные значения - distinct](#уникальные-значения---distinct)
+ [Группировка GROUP BY](#группировка--group-by)
+ [Агрегатные функции — count, sum, avg, обработка Null](#агрегатные-функции--count-sum-avg-обработка-null)
    + [AVG](#avg)
    + [Count](#count)
    + [Min и Max](#min-и-max)
+ [HAVING]()
+ [Приоритет операций]()
+ [Итоги]()
+ [Домашнее задание]()

[Содержание курса](/GB_SQL/README.md)

<hr>


# Тизер 

Сегодня мы узнаем:

1. Сортировка результатов запроса, сортировка по условиям
2. Ограничение выборки (top, limit, fetch),
3. Уникальные значения - distinct
4. Группировка — group by
5. Агрегатные функции — count, sum, avg, обработка Null
6. Использование Having
7. Порядок выполнения запроса

[Содержание](#содержание)

<hr>

# Термины лекции

__NULL__ соответствует понятию «пустое поле»null, то есть «поле, не содержащее никакого значения».

__Группировка__ — операция, которая создает из записей таблицы независимые группы записей, по которым проводится анализ.

__Агрегатные функции (агрегации)__ — это функции, которые вычисляются от группы значений и объединяют их в одно результирующее.

[Содержание](#содержание)

<hr>

# Сортировка результатов запроса

Когда мы выполняем SELECT запрос, в финальном результате строки возвращаются в неопределенном порядке. Фактический порядок строк зависит от порядка расположения данных в таблице. 

Для упорядочивания результатов запроса, используется конструкция ORDER BY.

## Синтаксис

```sql
SELECT expressions
FROM tables
[WHERE conditions]
ORDER BY expression [ ASC | DESC ];
```

## Параметры
+ __expressions__<br>
Столбцы или расчеты, которые вы хотите получить
+ __tables__<br>
Таблицы, из которых вы хотите получить записи. В предложении FROM должна быть указана хотя бы одна таблица
+ __WHERE conditions__<br>
Необязательный. Условия, которые должны быть выполнены для записей, которые будут выбраны
+ __ASC__<br>
Необязательный. ASC сортирует результирующий набор в порядке возрастания по expressions. Это поведение по умолчанию, если модификатор не указан.
+ __DESC__<br>
Необязательный. DESC сортирует результирующий набор в порядке убывания по expressions

В SQL часто кроме фильтрации данных, также часто требуется отсортировать их по одному из столбцов.

Оператор ORDER BY сортируют значения по одному или нескольких столбцам.

Например, упорядочим выборку из таблицы Products по столбцу Price:

```sql
SELECT * FROM Products
ORDER BY Price;
```

![003](/GB_SQL/Pictures/003_001.PNG)

Также можно производить упорядочивание данных по псевдониму столбца, который определяется с помощью оператора AS:

```sql
SELECT ProductName, ProductCount * Price AS TotalSum
FROM Products
ORDER BY TotalSum;
```
![003](/GB_SQL/Pictures/003_002.PNG)

В качестве критерия сортировки также можно использовать сложное выражение на основе столбцов:

```sql
SELECT Product Name, Price, Product Count
FROM Products
ORDER BY Product Count * Price;
```

![003](/GB_SQL/Pictures/003_003.PNG)

[Содержание](#содержание)

<hr>

# Ограничение выборки (top, limit, fetch)

## Оператор LIMIT
Оператор LIMIT позволяет извлечь определённый диапазон записей из одной или нескольких таблиц.

Общая структура запроса с оператором LIMIT

```sql
SELECT поля_выборки
FROM список_таблиц
LIMIT [количество_пропущенных_записей,] количество_записей_для_вывода;
```

Оператор LIMIT реализован не во всех СУБД, например, в MSSQL для вывода записей с начала таблицы используется оператор TOP, а для тех случаев, когда необходимо сделать отступ от начала таблицы, предназначена конструкция OFFSET FETCH.

Оператор LIMIT позволяет извлечь определенное количество строк и имеет следующий синтаксис:

```sql
LIMIT [offset,] rowcount
```

Если оператору LIMIT передается один параметр, то он указывает на количество извлекаемых строк. Если передается два параметра, то первый параметр устанавливает смещение относительно начала, то есть сколько строк нужно пропустить, а второй параметр также указывает на количество извлекаемых строк. Например, выберем первые три строки:

```sql
SELECT * FROM Products
LIMIT 2, З;
```

В данном случае пропускаются две первые строки и извлекаются следующие 3 строки:

![003](/GB_SQL/Pictures/003_004.PNG)

[Содержание](#содержание)

<hr>

## Аналоги: извлечение диапазона строк в MS SQL Server

В MS SQL Server можно также извлекать определённый диапазон строк, но для этого существуют другие конструкции и они немного сложнее, чем в MySQL. 

Аналогом LIMIT с одним параметром является оператор TOP. Он может применяться только с одним параметром и служит для вывода из таблицы первых строк, число которых указано в качестве параметра.

При помощи применённого ограничения диапазона будет выведена следующая таблица:

![003](/GB_SQL/Pictures/003_005.PNG)

[Содержание](#содержание)

<hr>

## Оператор fetch

Синтаксис оператора FETCH в MySQL:

```sql
SELECT ColumnNames FROM TableName ORDER BY ColumnName OFFSET
rows_to_be_skipped FETCH NEXT п ROWS ONLY;
```

Параметры или аргументы

Аргумент __OFFSET__ в MySQL определяет начальную точку строк, возвращаемых запросом. 

Запрос OFFSET отвечает за пропуск количества строк перед началом выборки строк из SQL-запроса.

__Offset_rows_count__ может быть задан константой, любым скаляром, переменной, любым параметром, большим или равным нулю. 

Предложение FETCH используется для возврата количества записей после выполнения предложения OFFSET

__Fetch_rows_count__ может быть задан константой, любым скаляром, переменной, любым параметром, большим или равным нулю. 

В запросе SQL необходимо использовать предложение OFFSET, но предложение FETCH может быть необязательным термином. 

Термины First и Next являются синонимами соответственно, чтобы добавлять их взаимозаменяемо, и то же самое для ключевых слов ASC и DESC для сортировки строк при выборке.

Мы можем посмотреть на полный синтаксис использования MySQL FETCH со OFFSET, чтобы вернуть количество строк, исключая первые строки, и получить следующие строки из таблицы. 

Это базовый синтаксис запроса для исключения первых m строк.

```sql
SELECT ColumnNames FROM TableName ORDER BY
ColumnNames OFFSET m ROWS FETCH NEXT p ROWS ONLY;
```

Теперь снова вы можете использовать следующий код, чтобы исключить m строк и выбрать следующие p строк из таблицы. Это будет извлекать строки только от (m+1) до (m+1+p).

[Содержание](#содержание)

<hr>

# Уникальные значения - distinct

С помощью оператора DISTINCT можно выбрать уникальные данные по определенным столбцам. К примеру, разные товары могут иметь одних и тех же производителей, и, допустим, у нас следующая таблица товаров:

![003](/GB_SQL/Pictures/003_006.PNG)

Применим оператор DISTINCT для выборки уникальных значений - уникальных производителей:

```sql
SELECT DISTINCT Manufacturer FROM Products;
```

Также мы можем задавать выборку уникальных значений по нескольким столбцам:

```sql
SELECT DISTINCT Manufacturer,
ProductCount FROM Products;
```
В данном случае для выборки используются столбцы Manufacturer и ProductCount. Из пяти строк только для двух строк эти столбцы имеют повторяющиеся значения. Поэтому в выборке будет 4 строки.

[Содержание](#содержание)

<hr>

# Группировка — GROUP BY

Операторы GROUP BY и HAVING позволяют сгруппировать данные. Они употребляются в рамках команды SELECT:

```sql
SELECT столбцы
FROM таблица
[WHERE условие_фильтрации_строк]
[GROUP ВY столбцы_для_группировки]
[HAVING условие_фильтрации_групп]
[ORDER ВY столбцы_для_сортировки]
```
GROUP BY

Оператор GROUP BY определяет, как строки будут группироваться.

Например, сгруппируем товары по производителю

```sql
SELECT Manufacturer, COUNT(*) AS ModelsCount
FROM Products
GROUP BY Manufacturer
```

![003](/GB_SQL/Pictures/003_007.PNG)

Первый столбец в выражении SELECT - Manufacturer представляет название группы, а второй столбец - ModelsCount представляет результат функции Count, которая вычисляет количество строк в группе.

[Содержание](#содержание)

<hr>

# Агрегатные функции — count, sum, avg, обработка Null

Агрегатные функции вычисляют некоторые скалярные значения в наборе строк. В MySQL есть следующие агрегатные функции:
+ AVG: вычисляет среднее значение
+ SUM: вычисляет сумму значений
+ MIN: вычисляет наименьшее значение
+ MAX: вычисляет наибольшее значение
+ COUNT: вычисляет количество строк в запросе

## AVG
Функция Avg возвращает среднее значение на диапазоне значений столбца таблицы. Например, пусть есть следующая таблица товаров Products:

![003](/GB_SQL/Pictures/003_008.PNG)

```sql
CREATE TABLE MoreProducts
(
Id INT AUTO_INCREMENT PRIMARY KEY,
ProductName VARCHAR(30) NOT NULL,
Manufacturer VARCHAR(20) NOT NULL,
ProductCount INT DEFAULT 0,
Price DECIMAL NOT NULL
);

INSERT INTO moreproducts(ProductName, Manufacturer, ProductCount, Price)
VALUES
('iPhone Х', 'Арр1е', 3, 76000),
('iPhone 8', 'Арр1е', 2, 51000),
('iPhone 7', 'Арр1е', 5, 32000),
('Galaxy S9', 'Samsung', 2, 56000),
('Galaxy S8', 'Samsung', 1, 46000),
('Honor 10', 'Huawei', 5, 28000),
('Nokia 8', 'HDM Gtoba1', 6, 38000);
```

![003](/GB_SQL/Pictures/003_009.PNG)

Cредняя цена товаров из БД:

Для поиска среднего значения в качестве выражения в функцию передается столбец Price. 

Для получаемого значения устанавливается псевдоним Average_Price, хотя в принципе устанавливать псевдоним необязательно.

```sql
SELECT AVG(Price) AS Average_Price FROM moreproducts
```

![003](/GB_SQL/Pictures/003_010.PNG)

[Содержание](#содержание)

<hr>

## Count
Функция Count вычисляет количество строк в выборке. Есть две формы этой функции. Первая форма COUNT(*) подсчитывает число строк в выборке:

```sql
SELECT COUNT(*) FROM MoreProducts
```

![003](/GB_SQL/Pictures/003_011.PNG)


[Содержание](#содержание)

<hr>

## Min и Max
Функции Min и Max вычисляют минимальное и максимальное значение по столбцу соответственно. Например, найдем минимальную цену среди товаров:

```sql
SELECT MIN(Price), MAX(Price) FROM Products;
```

![003](/GB_SQL/Pictures/003_012.PNG)

Данные функции также игнорируют значения NULL и не учитывают их при подсчете.

[Содержание](#содержание)

<hr>

# HAVING

В MySQL оператор HAVING используется в сочетании с оператором GROUP BY, чтобы ограничить группы возвращаемых строк только тех, чье условие TRUE.

Синтаксис оператора HAVING в MySQL:

```sql
SELECT expression1, expression2, ... expression_n,
aggregate_function (expression)
FROM tables
[WHERE conditions]
GROUP BY expression1, expression2, ... expression_n
HAVING condition;
```

Параметры или аргументы

__aggregate_function__ - функция, такая как функции [SUM](https://oracleplsql.ru/mysql-function-sum.html), [COUNT](https://oracleplsql.ru/mysql-function-count.html),
[MIN](https://oracleplsql.ru/mysql-function-min.html), [MAX](https://oracleplsql.ru/mysql-function-max.html) или [AVG](https://oracleplsql.ru/mysql-function-avg.html).

__expression1, expression2, ... expression_n__ - выражения, которые не заключены в агрегированную функцию и должны быть включены в предложение GROUP BY.

__WHERE conditions__ - необязательный. Это условия для выбора записей.

__HAVING condition__ - Это дополнительное условие применяется только к агрегированным результатам для ограничения групп возвращаемых строк. В результирующий набор будут включены только те группы, состояние которых соответствует TRUE.

__Фильтрация групп. HAVING__

Оператор HAVING позволяет выполнить фильтрацию групп, то есть определяет, какие группы будут включены в выходной результат.

Использование HAVING во многом аналогично применению WHERE. 

Только если WHERE применяется для фильтрации строк, то HAVING - для фильтрации групп.

Например, найдем все группы товаров по производителям, для которых определено более 1 модели:

```sql
SELECT Manufacturer, COUNT(*) AS Mode1sCount
FROM MoreProducts
GROUP BY Manufacturer
HAVING COUNT(*) > 1
```

![003](/GB_SQL/Pictures/003_013.PNG)

```sql
SELECT Manufacturer, COUNT(*) AS Mode1sCount
FROM MoreProducts
WHERE Price * ProductCount > 80000
GROUP BY Manufacturer
HAVING COUNT(*) > 2
```

![003](/GB_SQL/Pictures/003_014.PNG)

То есть в данном случае сначала фильтруются строки: выбираются те товары, общая стоимость которых больше 80000.

Затем выбранные товары группируются по производителям. И далее фильтруются сами группы - выбираются те группы, которые содержат больше 1 модели.

Если при этом необходимо провести сортировку, то выражение ORDER BY идет после выражения HAVING:

```sql
SELECT Manufacturer, COUNT(*) AS Models, SUM(Product Count) AS Units
FROM Products
WHERE Price * ProductCount > 80000
GROUP BY Manufacturer
HAVING SUM(ProductCount) > 2
ORDER BY Units DESC;
```

![003](/GB_SQL/Pictures/003_015.PNG)

Здесь группировка идет по производителям, и также выбирается количество моделей для каждого производителя (Models) и общее количество всех товаров по всем этим моделям (Units). В конце группы сортируются по количеству товаров по убыванию.

[Содержание](#содержание)

<hr>

[Содержание курса](/GB_SQL/README.md)


